---
title: "Untitled"
author: "Xuran Yan"
date: '2022-06-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packs, message = FALSE}
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(dplyr)
library(Amelia)
library(forcats)
library(bnlearn)
library(Rgraphviz)
```

# Data Preparation
```{r}
# load dataset
load("easySHARE_rel8_0_0.rda")
easyshare = easySHARE_rel8_0_0

# select variables
easyshare <- easyshare %>%  dplyr::select(c(wave, age, female, country_mod, isced1997_r, chronic_mod, ever_smoked, smoking, br010_mod, eurod, bmi2, sp002_mod, sp008_, br015_, recall_1, recall_2, orienti, numeracy_1, numeracy_2))
# rename
easyshare <- easyshare %>% rename(education = isced1997_r, drinking = br010_mod, depression = eurod, vigorous_act = br015_)

# set missing value as NA
easyshare[easyshare < 0] <- NA

# discretize and factorise variables
easyshare$age <- cut(easyshare$age, breaks = c(0,seq(55,90,5),120), ordered_result = TRUE, right = FALSE)
easyshare$female <- factor(easyshare$female, ordered = TRUE)
easyshare$education <- factor(easyshare$education, ordered = TRUE)
easyshare$chronic_mod <- factor(easyshare$chronic_mod, ordered = TRUE)
easyshare$drinking <- factor(easyshare$drinking, ordered = TRUE)
easyshare$depression <- factor(easyshare$depression, ordered = TRUE)
easyshare$bmi2 <- factor(easyshare$bmi2, ordered = TRUE)
easyshare$vigorous_act <- factor(easyshare$vigorous_act, ordered = TRUE)

# create a composite cognitive score as a proxy for dementia severity
easyshare$cogscore = easyshare$recall_1 + easyshare$recall_2
easyshare$cogscore <- cut(easyshare$cogscore, breaks = c(0, quantile(easyshare$cogscore, probs = c(.1,.4),na.rm=TRUE),29), ordered_result = TRUE)

# divided country into 4 areas
easyshare$country_area <- ifelse(easyshare$country_mod %in% c(203,348,428,703), "E", ifelse(easyshare$country_mod %in% c(40,56,250,276,442,528,756), "W", ifelse(easyshare$country_mod %in% c(208,233,246,372,440,616,752), "N", "S")))
easyshare$country_area<- factor(easyshare$country_area, ordered = TRUE)

# create a social variable
easyshare$social_help <- easyshare$sp002_mod + easyshare$sp008_
easyshare$social_help <- factor(easyshare$social_help, ordered = TRUE)

# create a smoke variable
easyshare$smoke <- easyshare$ever_smoked + easyshare$smoking
easyshare$smoke <- factor(easyshare$smoke, ordered = TRUE)
```

## Wave selection
```{r}
# show the observations in each wave
table(easyshare$wave)
# drop variables related to cogscore with large amount of missing values
easyshare = subset(easyshare, select=-c(orienti, numeracy_1, numeracy_2))
# to select wave with less missing values
for (i in 4:8){
  missmap(easyshare[easyshare$wave==i,], col = c("firebrick1", "dodgerblue"), main = paste("Missingness Map wave",i))
}
# focus the research on wave 5
easyshare_sub = easyshare[easyshare$wave==5,]
easyshare_sub_narm <- easyshare_sub[complete.cases(easyshare_sub),]
```

## Visualiaztion

```{r, fig.height=15, fig.width=24}
p1 = ggplot() + geom_bar(aes(x = easyshare_sub$cogscore),color="darkblue", fill="lightblue")+  labs(x ="Cogntive impairment")
p2 = ggplot() + geom_bar(aes(x = easyshare_sub$age),color="darkblue", fill="lightblue")+  labs(x ="Age")
p3 = ggplot() + geom_bar(aes(x = easyshare_sub$female),color="darkblue", fill="lightblue")+  labs(x ="Gender")
p4 = ggplot() + geom_bar(aes(x = easyshare_sub$education),color="darkblue", fill="lightblue")+  labs(x ="Education") +  geom_density(color = "black", fill = "gray")
p5 = ggplot() + geom_bar(aes(x = easyshare_sub$country_area),color="darkblue", fill="lightblue")+  labs(x ="Area of country")
p6 = ggplot() + geom_bar(aes(x = easyshare_sub$social_help),color="darkblue", fill="lightblue")+  labs(x ="social")
p7 = ggplot() + geom_bar(aes(x = easyshare_sub$chronic_mod),color="darkblue", fill="lightblue")+  labs(x ="Number of chronic diseases")
p8 = ggplot() + geom_bar(aes(x = easyshare_sub$smoke),color="darkblue", fill="lightblue")+  labs(x ="Smoke")
p9 = ggplot() + geom_bar(aes(x = easyshare_sub$drinking),color="darkblue", fill="lightblue")+  labs(x ="Drinking behavior")
p10 = ggplot() + geom_bar(aes(x = easyshare_sub$depression),color="darkblue", fill="lightblue")+  labs(x ="Depression scale")
p11 = ggplot() + geom_bar(aes(x = easyshare_sub$bmi2),color="darkblue", fill="lightblue")+  labs(x ="Body Mass Index")
p12 = ggplot() + geom_bar(aes(x = easyshare_sub$vigorous_act),color="darkblue", fill="lightblue")+  labs(x ="vigorous activities")

grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, nrow = 3)
```

## Rearrangement of variables's levels
```{r}
# age
easyshare_sub$age=easyshare_sub$age %>% fct_collapse(">80" = c("[80,85)", "[85,90)","[90,120)"))
# cognitive score
levels(easyshare_sub$cogscore) <- c("low","moderate","high")
# gender
levels(easyshare_sub$female) <- c("male","female")
# education
levels(easyshare_sub$education) <- list("basic" = c("1","2"), "secondary" = c("3","4"), "tertiary" = c("5","6"), "other" = c("0","95","97"))
# number of chronic diseases
levels(easyshare_sub$chronic_mod) <- list("none" = "0", "less" = c("1","2"), "much" = c("3","4","5","6","7","8","9","10"))
# smoke
levels(easyshare_sub$smoke) <- list("non-smoke" = "10", "smoke" = c("2","6"))
# drinking
levels(easyshare_sub$drinking) <- list("low" = c("1","2"), "moderate" = c("3","4","5"), "high" = c("6","7"))
# depression
levels(easyshare_sub$depression) <- list("low" = c("0","1","2","3"), "moderate" = c("4","5","6","7"), "high" = c("8","9","10","11","12"))
# social help
levels(easyshare_sub$social_help) <- list("social" = "2", "moderate" = "6", "no social" = "10")

# drop useless variables
easyshare_sub = subset(easyshare_sub, select=-c(wave, country_mod, recall_1, recall_2, ever_smoked, smoking, sp002_mod, sp008_, orienti, numeracy_1, numeracy_2))
# drop NA variables 
easyshare_sub_narm <- easyshare_sub[complete.cases(easyshare_sub),]
```

# Models Compared

```{r}
# Create blacklist and whitelist  
myblacklist = matrix(c("cogscore","age",
                   "female","age",
                   'country_area', "age",
                   "education","age",
                   "chronic_mod","age",
                   'smoke', "age",
                   'drinking', "age",
                   'depression', "age",
                   'bmi2', "age",
                   'vigorous_act', "age",
                   "age","female",
                   "country_area","female",
                   "education","female",
                   "cogscore","female",
                   'chronic_mod', "female",
                   'smoke', "female",
                   'drinking', "female",
                   'depression', "female",
                   'bmi2', "female",
                   'vigorous_act', "female",
                   "age","country_area",
                   "female","country_area",
                   "education","country_area",
                   "cogscore","country_area",
                   'chronic_mod', "country_area",
                   'smoke', "country_area",
                   'drinking', "country_area",
                   'depression', "country_area",
                   'bmi2', "country_area",
                   'vigorous_act', "country_area",
                   "cogscore","age",
                   "cogscore","female",
                   "cogscore","education",
                   "cogscore",'chronic_mod', 
                   "cogscore",'smoke', 
                   "cogscore","country_area",
                   "cogscore",'drinking', 
                   "cogscore",'depression', 
                   "cogscore",'bmi2', 
                   "cogscore", 'vigorous_act',
                   "cogscore",'social_help', 
                   'social_help', "country_area",
                   'social_help', "female",
                   'social_help', "age",
                   "smoke","education",
                   "drinking","education",
                   'vigorous_act',"education",
                   "bmi2","education"), 
                 byrow = TRUE, ncol=2, dimnames =list(NULL,c("from","to")))

mywhitelist = matrix(c("drinking","chronic_mod",
                       "smoke","chronic_mod"),
                 byrow = TRUE, ncol=2, dimnames =list(NULL,c("from","to")))
```

```{r}
# constraint-based algorithm: iamb
easyshare_sub.iamb =iamb(easyshare_sub, blacklist = myblacklist,whitelist = mywhitelist, test="mi")
graphviz.plot(easyshare_sub.iamb)

# score-based structure algorithm: hc(bic)
easyshare_sub.hc =hc(easyshare_sub_narm, blacklist = myblacklist, whitelist = mywhitelist, score="bic")
graphviz.plot(easyshare_sub.hc)

# score-based structure algorithm: hc(bde)
easyshare_sub.hc2 =hc(easyshare_sub_narm, blacklist = myblacklist, whitelist = mywhitelist, score="bde")
graphviz.plot(easyshare_sub.hc2)
```

```{r}
# compare the learning algorithm and choose with smallest expected loss
bn.cv(data = easyshare_sub_narm, bn = easyshare_sub.iamb, loss = "pred", loss.args = list(target = "cogscore"))
bn.cv(data = easyshare_sub_narm, bn = easyshare_sub.hc, loss = "pred", loss.args = list(target = "cogscore"))
bn.cv(data = easyshare_sub_narm, bn = easyshare_sub.hc2, loss = "pred", loss.args = list(target = "cogscore"))
```

## Model optimization
```{r}
# add the line from social_help to depression: can not add
dag=easyshare_sub.iamb
dag=set.arc(dag, from = "social_help", to= "depression")
bn.cv(data = easyshare_sub_narm, bn = dag, loss = "pred", loss.args = list(target = "cogscore"))
```

```{r}
# drop the line from country_area to social_help: can drop
dag2=easyshare_sub.iamb
dag2=drop.arc(dag2,  from = "country_area", to= "social_help")
bn.cv(data = easyshare_sub_narm, bn = dag2, loss = "pred", loss.args = list(target = "cogscore"))
```

```{r}
# add the line from social_help to depression: can not add
dag3=dag2
dag3=set.arc(dag3, from = "social_help", to= "depression")
bn.cv(data = easyshare_sub_narm, bn = dag3, loss = "pred", loss.args = list(target = "cogscore"))
```

## Modle fitting: learning local distributions

```{r, fig.height=15, fig.width=20}
# fit parameters
bn.bayes = bn.fit(easyshare_sub.iamb, data=easyshare_sub_narm, method = "bayes",iss=10)

# levels of 
age.lv = levels(easyshare_sub_narm$age)
gender.lv = levels(easyshare_sub_narm$female)
edu.lv = levels(easyshare_sub_narm$education)
dep.lv = levels(easyshare_sub_narm$depression)

for (i in 1:dim(bn.bayes$cogscore$prob)[3]){
  for (j in 1:dim(bn.bayes$cogscore$prob)[4]){
    for (k in 1:dim(bn.bayes$cogscore$prob)[5]){
        print(ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3), y=matrix(t(bn.bayes$cogscore$prob[,,i,j,k]), ncol =1), 
                           color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
        geom_point() +
        geom_line() + 
        scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
        labs(x = "Age", y= "Conditional probability", color = "Cognitive score", 
             title = paste(gender.lv[i],paste(edu.lv[j],"education",sep=' '),paste(dep.lv[k],"depression",sep=' '),sep=', ')))
    }
  }
}

for (i in 1:dim(bn.bayes$cogscore$prob)[3]){
  for (j in 1:dim(bn.bayes$cogscore$prob)[5]){
    p1 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3), y=matrix(t(bn.bayes$cogscore$prob[,,i,1,j]), ncol =1), 
                           color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
        geom_point() +
        geom_line() + 
        scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
        labs(x = "Age", y= "Conditional probability", color = "Cognitive score", 
             title = paste(gender.lv[i],"Basic education",paste(dep.lv[k],"depression",sep=' '),sep=', '))
    p2 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3), y=matrix(t(bn.bayes$cogscore$prob[,,i,2,j]), ncol =1), 
                           color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
        geom_point() +
        geom_line() + 
        scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
        labs(x = "Age", y= "Conditional probability", color = "Cognitive score", 
             title = paste(gender.lv[i],"Secondary education",paste(dep.lv[k],"depression",sep=' '),sep=', '))
    p3 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3), y=matrix(t(bn.bayes$cogscore$prob[,,i,3,j]), ncol =1), 
                           color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
        geom_point() +
        geom_line() + 
        scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
        labs(x = "Age", y= "Conditional probability", color = "Cognitive score", 
             title = paste(gender.lv[i],"Tertiary education",paste(dep.lv[k],"depression",sep=' '),sep=', '))
    p4 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3), y=matrix(t(bn.bayes$cogscore$prob[,,i,4,j]), ncol =1), 
                           color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
        geom_point() +
        geom_line() + 
        scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
        labs(x = "Age", y= "Conditional probability", color = "Cognitive score", 
             title = paste(gender.lv[i],"Other education",paste(dep.lv[k],"depression",sep=' '),sep=', '))

    grid.arrange(p1,p2,p3,p4, col=2)
  }
}
```


```{r, fig.height=15, fig.width=20}
# age as abscissa
p1 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,1,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Basic education, Low depression")

p2 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,1,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Female, Basic education, Low depression")

p3 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,2,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Secondary education, Low depression")

p4 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,2,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Famale, Secondary education, Low depression")

p5 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,3,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Tertiary education, Low depression")

p6 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,3,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Female, Tertiary education, Low depression")

p7 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,4,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Other education, Low depression")

p8 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,4,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Famale, Other education, Low depression")
########################
p9 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,1,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Basic education, Moderate depression")

p10 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,1,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Female, Basic education, Moderate depression")

p11 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,2,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Secondary education, Moderate depression")

p12 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,2,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Famale, Secondary education, Moderate depression")

p13 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,3,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Tertiary education, Moderate depression")

p14 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,3,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Female, Tertiary education, Moderate depression")

p15 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,4,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Other education, Moderate depression")

p16 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,4,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Famale, Other education, Moderate depression")

grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12,p13,p14,p15,p16, nrow = 4)
```


```{r, fig.height=15, fig.width=20}
##################################
p5 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Other education, Moderate quality of life")

p6 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Basic education, Moderate quality of life")

p7 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,3,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Secondary education, Moderate quality of life")

p8 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,4,2]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Tertiary education, Moderate quality of life")

########################

p9 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,3]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Other education, High quality of life")

p10 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,3]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Basic education, High quality of life")

p11 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,3,3]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Secondary education, High quality of life")

p12 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,4,3]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Tertiary education, High quality of life")


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, nrow = 3)
```

```{r}
p1 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,1,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Other education, Low quality of life")

p2 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,2,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Basic education, Low quality of life")

p3 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,3,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Secondary education, Low quality of life")

p4 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes$cogscore$prob[,,4,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Tertiary education, Low quality of life")
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

## Modle fitting: learning local distributions via a custom fit
```{r}
library(MASS)
olr.fitf =polr(cogscore ~ age + education+depression, data = easyshare_sub_narm[easyshare_sub_narm$female=="female",])
olr.fitm =polr(cogscore ~ age + education+depression, data = easyshare_sub_narm[easyshare_sub_narm$female=="male",])
edu.lv = levels(easyshare_sub_narm$education)
age.lv = levels(easyshare_sub_narm$age)
f.lv = levels(easyshare_sub_narm$female)
cs.lv = levels(easyshare_sub_narm$cogscore)
dep.lv = levels(easyshare_sub_narm$depression)
combos = data.frame(age=rep(age.lv,12), female=rep(f.lv,each = 42), education=rep(edu.lv,each = 21), depression=rep(dep.lv,each = 28))
distcsf = predict(olr.fitf, newdata= combos ,type="p")
distcsm = predict(olr.fitm, newdata= combos ,type="p")
distcs = array(dim = c(length(cs.lv), length(age.lv), length(f.lv), length(edu.lv), length(dep.lv)), dimnames = list(cogscore = cs.lv, age = age.lv, female = f.lv, education = edu.lv, depression = dep.lv))
distcs[,,1,,] = array(t(distcsm), dim=c(length(cs.lv), length(age.lv), 1, length(edu.lv), length(dep.lv)))
distcs[,,2,,] = array(t(distcsf), dim=c(length(cs.lv), length(age.lv), 1, length(edu.lv), length(dep.lv)))
bn.bayes2 = bn.bayes
bn.bayes2$cogscore = distcs

bn.fit.barchart(bn.bayes2$cogscore)
```


```{r}
p1 = ggplot(mapping = aes(x = rep(seq(1:length(levels(easyshare_sub_narm$age))),3),
                     y=matrix(t(bn.bayes2$cogscore$prob[,,1,1,1]), ncol =1), color = rep(levels(easyshare_sub_narm$cogscore), each = length(levels(easyshare_sub_narm$age))))) + 
  geom_point() +
  geom_line() +
  scale_x_discrete(breaks=seq(1:length(levels(easyshare_sub_narm$age))),
        labels=levels(easyshare_sub_narm$age)) +
  labs(x = "Age", y= "Conditional probability", color = "Cognitive score", title ="Male, Basic education, Low depression")
```

