---
title: "Untitled"
author: "Xuran Yan"
date: '2022-06-07'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
load("easySHARE_rel8_0_0.rda")
easyshare = easySHARE_rel8_0_0
```

```{r packs, message = FALSE}
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(dplyr)
```

--------------------variable selection

```{r}
# select variables
easyshare <- easyshare %>%  dplyr::select(c(wave, age, female, country_mod, isced1997_r, chronic_mod, ever_smoked, br010_mod, casp, eurod, bmi2, sp002_mod, sp008_, br015_, mar_stat, euro5, recall_1, recall_2, orienti, numeracy_1, numeracy_2))
# rename
easyshare <- easyshare %>% rename(education = isced1997_r, drinking = br010_mod, depression = eurod, recieve_help = sp002_mod, give_help = sp008_, vigorous_act = br015_, sleep = euro5)
```

--------------------wave:

```{r}
# show the observations in each wave
table(easyshare$wave)
```

choose wave 4,5,6,7,8 since they contain large number of variables


----------------cognitives score

EasySHARE does not record diagnosis of dementia (e.g. Alzheimer's disease) in all waves. Instead, we will create a composite cognitive score as a proxy for dementia severity, following [Crimmins et al. (2011)](https://pubmed.ncbi.nlm.nih.gov/21743047/).

since variables orienti, numeracy_1 and numeracy_2 have high amount of missing values in waves 4, 5, 6, 7, and 8, so it is reasonable to only add recall_1 and recall_2 as the cognitive score

```{r}
# create a composite cognitive score as a proxy for dementia severity
easyshare$cogscore = easyshare$recall_1 + easyshare$recall_2
```


----------------------Country:

Austria 40, Belgium 56, Bulgaria 100, Croatia 191, Cyprus 196, Czech Republic 203, 
Denmark 208, Estonia 233, Finland 246, France 250, Germany 276, Greece 300, Hungary 348, Ireland 372, Israel 376, 
Italy 380, Latvia 428, Lithuania 440, Luxembourg 442, Malta 470, the Netherlands 528, Poland 616, Portugal 620, 
Romania 642, Slovakia 703, Slovenia 705, Spain 724, Sweden 752, and Switzerland 756. 

As mentioned in the (Dementia prevention, intervention, and care), more dementias occur in low-income and middle-income countries (LMIC), however, according to the recording to the Countries by Income Group, expect Hungary, Bulgaria and Romania are Upper-middle-income countriesm, all other countries are High-income countries, so we can not divided countries into groups by income because of the inbalance sample between groups.

divided into 4 parts west north south and east according to https://en.wikipedia.org/wiki/Regions_of_Europe:
east: Czech Republic, Hungary, Latvia, Slovak Republic
west: Austria, Belgium, France, Germany, Luxembourg, Netherlands, Switzerland
north: Denmark, Estonia, Finland, Ireland, Lithuania, Poland, Sweden
south: Bulgaria, Croatia, Cyprus, Greece, Israel, Italy, Malta, Portugal, Romania, Slovenia, Spain

```{r}
easyshare$area <- ifelse(easyshare$country_mod %in% c(203,348,428,703), "E", ifelse(easyshare$country_mod %in% c(40,56,250,276,442,528,756), "W", ifelse(easyshare$country_mod %in% c(208,233,246,372,440,616,752), "N", "S")))
```


------------------- visualize variables


```{r}
# set missing value as NA
easyshare[easyshare < 0] <- NA

easyshare$age <- cut(easyshare$age, breaks = c(0,seq(50,90,10),120), ordered_result = TRUE, right = FALSE)
easyshare$cogscore <- cut(easyshare$cogscore, breaks = c(0, quantile(easyshare$cogscore, probs = c(.1,.4),na.rm=TRUE),29), ordered_result = TRUE)
easyshare$casp <- cut(easyshare$casp, breaks = c(12, quantile(easyshare$casp, probs = c(.1,.4),na.rm=TRUE),48), ordered_result = TRUE)
easyshare$area<- factor(easyshare$area)
easyshare$female <- factor(easyshare$female)
easyshare$education <- factor(easyshare$education, ordered = TRUE)
easyshare$chronic_mod <- factor(easyshare$chronic_mod)
easyshare$ever_smoked <- factor(easyshare$ever_smoked)
easyshare$drinking <- factor(easyshare$drinking)
easyshare$depression <- factor(easyshare$depression)
easyshare$bmi2 <- factor(easyshare$bmi2)
easyshare$recieve_help <- factor(easyshare$recieve_help)
easyshare$give_help <- factor(easyshare$give_help)
easyshare$vigorous_act <- factor(easyshare$vigorous_act)
easyshare$mar_stat <- factor(easyshare$mar_stat)
easyshare$sleep <- factor(easyshare$sleep)
# head(easyshare)
```

```{r}
easyshare_sub = subset(easyshare, easyshare$wave %in% c("4", "5", "6", "7", "8"))
ggplot() + geom_bar(aes(x = easyshare_sub$age),color="darkblue", fill="lightblue")+  labs(x ="Age")
ggplot() + geom_bar(aes(x = easyshare_sub$cogscore),color="darkblue", fill="lightblue")+  labs(x ="Cogntive impairment")
ggplot() + geom_bar(aes(x = easyshare_sub$casp),color="darkblue", fill="lightblue")+  labs(x ="Quality of life")

ggplot() + geom_bar(aes(x = easyshare_sub$area),color="darkblue", fill="lightblue")+  labs(x ="Area(country)")
ggplot() + geom_bar(aes(x = easyshare_sub$female),color="darkblue", fill="lightblue")+  labs(x ="Gender")
ggplot() + geom_bar(aes(x = easyshare_sub$education),color="darkblue", fill="lightblue")+  labs(x ="Education") + geom_density(color = "black", fill = "gray")
ggplot() + geom_bar(aes(x = easyshare_sub$chronic_mod),color="darkblue", fill="lightblue")+  labs(x ="Number of chronic diseases")
ggplot() + geom_bar(aes(x = easyshare_sub$ever_smoked),color="darkblue", fill="lightblue")+  labs(x ="Ever smoked daily")
ggplot() + geom_bar(aes(x = easyshare_sub$drinking),color="darkblue", fill="lightblue")+  labs(x ="Drinking behavior")
ggplot() + geom_bar(aes(x = easyshare_sub$depression),color="darkblue", fill="lightblue")+  labs(x ="Depression scale")
ggplot() + geom_bar(aes(x = easyshare_sub$bmi2),color="darkblue", fill="lightblue")+  labs(x ="Body Mass Index")
ggplot() + geom_bar(aes(x = easyshare_sub$recieve_help),color="darkblue", fill="lightblue")+  labs(x ="Received help from outside the household")
ggplot() + geom_bar(aes(x = easyshare_sub$give_help),color="darkblue", fill="lightblue")+  labs(x ="Given help to others outside the household")
ggplot() + geom_bar(aes(x = easyshare_sub$vigorous_act),color="darkblue", fill="lightblue")+  labs(x ="vigorous activities")
ggplot() + geom_bar(aes(x = easyshare_sub$mar_stat),color="darkblue", fill="lightblue")+  labs(x ="Marital status")
ggplot() + geom_bar(aes(x = easyshare_sub$sleep),color="darkblue", fill="lightblue")+  labs(x ="Sleep")

```


------------------------- deal with missing values

```{r}
#### mordified levels for each variables: combine intervals for small counts reasonable, rename the leval
library(forcats)
#age: 
easyshare_sub$age=easyshare_sub$age %>% fct_collapse("<60" = c("[0,50)","[50,60)"))
easyshare_sub$age=easyshare_sub$age %>% fct_collapse(">80" = c("[80,90)","[90,120)"))
# cognitive score
levels(easyshare_sub$cogscore) <- c("low","moderate","high")
# quality of life
levels(easyshare_sub$casp) <- c("low","moderate","high")
# gender
levels(easyshare_sub$female) <- c("male","female")
# education
easyshare_sub$education=easyshare_sub$education %>% fct_collapse("other" = c("95","97"))
# Number of chronic diseases: 7,8,9 are not included in chronic_mod
easyshare_sub$chronic_mod[which(easyshare_sub$chronic_mod %in% c("7","8","9"))]=NA
easyshare_sub$chronic_mod=droplevels(easyshare_sub$chronic_mod)
# smoke
levels(easyshare_sub$ever_smoked) <- c("yes","no")
# drinking
easyshare_sub$drinking=easyshare_sub$drinking %>% fct_collapse("2+3" = c("2","3"))
easyshare_sub$drinking=easyshare_sub$drinking %>% fct_collapse("5+6" = c("5","6"))
# depression
easyshare_sub$depression=easyshare_sub$depression %>% fct_collapse("low" = c("0","1","2","3"))
easyshare_sub$depression=easyshare_sub$depression %>% fct_collapse("moderate" = c("4","5","6","7"))
easyshare_sub$depression=easyshare_sub$depression %>% fct_collapse("high" = c("8","9","10","11","12"))
# received and given help
levels(easyshare_sub$recieve_help) <- c("yes","no")
levels(easyshare_sub$give_help) <- c("yes","no")
# marriage state: registered partnership and marriage are now virtually the same, from a legal point of view
# easyshare_sub$mar_stat=easyshare_sub$mar_stat %>% fct_collapse()
levels(easyshare_sub$mar_stat) <- list("never married" = "4", "divorced" = "5", "widowed" = "6", "married" = c("1","2","3"))
# sleep
levels(easyshare_sub$sleep) <- c("no","yes")

#### impute data
# age
# cognitive score
# education
# Number of chronic diseases:
# body mass index
# marriage state 


#### drop variables NA
new<- easyshare_sub[complete.cases(easyshare_sub),]
```


-------------------------------- BN-------------------------------


```{r}
library(bnlearn)
library(Rgraphviz)
```

```{r}
myblacklist = matrix(c("cogscore","age",
                   "female","age",
                   "education","age",
                   'self_perceived_health', "age",
                   'chronic_mod', "age",
                   'smoking', "age",
                   'ever_smoked', "age",
                   'drinking', "age",
                   'casp', "age",
                   'depression', "age",
                   'bmi2', "age",
                   'daily_act', "age",
                   'daily_instrumental_act', "age",
                   'recieve_help', "age",
                   'give_help', "age",
                   'vigorous_act', "age",
                   'mar_stat', "age",
                   'sleep',"age",
                   "age","female",
                   "education","female",
                   "cogscore","female",
                   'self_perceived_health', "female",
                   'chronic_mod', "female",
                   'smoking', "female",
                   'ever_smoked', "female",
                   'drinking', "female",
                   'casp', "female",
                   'depression', "female",
                   'bmi2', "female",
                   'daily_act', "female",
                   'daily_instrumental_act', "female",
                   'recieve_help', "female",
                   'give_help', "female",
                   'vigorous_act', "female",
                   'mar_stat', "female",
                   'sleep',"female",
                   "cogscore","education",
                   "cogscore",'self_perceived_health', 
                   "cogscore",'chronic_mod', 
                   "cogscore",'smoking', 
                   "cogscore",'ever_smoked', 
                   "cogscore",'drinking', 
                   "cogscore",'casp', 
                   "cogscore",'depression', 
                   "cogscore",'bmi2', 
                   "cogscore",'daily_act', 
                   "cogscore",'daily_instrumental_act', 
                   "cogscore",'recieve_help', 
                   "cogscore",'give_help', 
                   "cogscore", 'vigorous_act', 
                   "cogscore",'mar_stat', 
                   "cogscore",'sleep',
                   "education","mar_stat",
                   "education",'self_perceived_health',
                   "education",'chronic_mod',
                   "education",'bmi2'), 
                 byrow = TRUE, ncol=2, dimnames =list(NULL,c("from","to")))

# Use incremental association Markov blanket to learn the DAG
easyshare_sub.iamb =iamb(easyshare_sub, blacklist = myblacklist, test="mi")
graphviz.plot(easyshare_sub.iamb)
```



